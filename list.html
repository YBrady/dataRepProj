<!DOCTYPE html>
<html>

<head>
    <title>List Admin</title>

        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
            integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
        <link rel="stylesheet" type="text/css" href="style.css">

        <!-- Needed to fix a favicon.ico on Chrome -->
    <link rel="shortcut icon" href="#" />

    <script type="text/javascript" src="snowstorm.js"></script>
    <!--- Call the script for AJAX -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    
    <script type="text/javascript">
        //snowStorm.snowColor = '#99ccff'; // blue-ish snow!?
        snowStorm.flakesMaxActive = 96;  // show more snow on screen at once
        snowStorm.useTwinkleEffect = true; // let the snow flicker in and out of view
    </script>

</head>
<body>
        <!-- ----------------The Nav Bar Start----------------->
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <!-- Logo Begin -->
            <a class="navbar-brand" href="#">
                <img src="images/logo.png" width="170" class="d-inline-block align-top" onclick="magic()"
                    alt="Magic of Christmas">
            </a>
            <!-- Logo End -->
            <span id="loginUser"></span>
            <!-- Making Navbar hamburger menu -->
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarText"
                aria-controls="navbarText" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <!-- Navigation Items -->
            <div class="collapse navbar-collapse" id="navbarText">
                <ul class="navbar-nav mr-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="home.html">Home <span class="sr-only">(current)</span></a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="list.html">List Admin</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="workshop.html">Workshop Admin</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="other.html">Weather & Messaging Centre</a>
                    </li>
                </ul>
                <!-- Search Box -->
                <form class="form-inline">
                    <input class="form-control mr-sm-2" id="search" type="search" placeholder="Naughty or Nice?"
                        aria-label="Search">
                    <button class="btn btn-outline-success my-2 my-sm-0" onclick="naughtyOrNice()">Check the List</button>
                    <button class="btn btn-outline-success m-2 my-sm-0" id="Logou" onclick="logOut()">Logout</button>
                </form>
            </div>
        </nav>
        <!-- --------------The Nav Bar End --------------->
    <div class="container">
        <div class="row align-items-center justify-content-between form-group">
            <!-- The Nice List-->
            <div class ="col-sm-4">
                <p class="header" id = "niceList">The Nice List</p> 
            </div>
            <div class="coll-sm-4">
                <button class="btn btn-outline-success btn-lg btn-block" id="showCreateButton" onclick="showCreate()">+ Add New Person</button>
            </div>
            <!-- The Naughty List-->
            <div class ="coll-sm-4">
                <p class="header" id="naughtyList">The Naughty List</p>
            </div>
        </div>
        <div class="row justify-content-between">
            <div class="col-sm-6">
                <table class="table table-sm table-striped table-light" id="theNiceList">
                    <tr>
                        <th>id</th>
                        <th>Name</th>
                        <th>Gender</th>
                        <th>Age</th>
                        <th>Nice</th>
                        <th>Toy</th>
                        <th>Chimney</th>
                        <th>Action</th>
                    </tr>
                </table>

            </div>

            <div class="col-sm-6">
                <table class="table table-sm  table-striped table-dark" id="theNaughtyList">
                    <tr>
                        <th>id</th>
                        <th>Name</th>
                        <th>Gender</th>
                        <th>Age</th>
                        <th>Nice</th>
                        <th>Toy</th>
                        <th>Chimney</th>
                        <th>Action</th>
                    </tr>
                </table>
            </div>
        </div>
        </div>
    
        <!-- Create / Delete / Update Form  -- Begin -->
        <div class="container" id="createUpdateForm" style="display:none">
            <div class="row form-group">
                <h2><span id="createLabel">Add a</span><span id="updateLabel">Update / Delete this</span> Person</h2>
            </div>
            <input type="hidden" name="id"/>
            <input type="hidden" name="listname"/>
            <div class="row form-group">
                <div class="col-sm-1">
                    <p style="color:white">Name</p>
                </div>
                <div class="col-sm-2">
                    <input type="text" name="name"><br />
                </div>
                <div class="col-sm-1">
                    <p style="color:white">Age</p>
                </div>
                <div class="col-sm-2">
                    <input type="number" name="age"><br />
                </div>
                <div class="col-sm-1">
                    <p style="color:white">Toy</p>
                </div>
                <div class="col-sm-2">
                    <input type="text" name="toy"><br />
                </div>
            </div>
            <div class="row"></div>
            <div class="row form-group">
                <div class="col-sm-1">
                    <p style="color:white">Gender</p>
                </div>
                <div class="col-sm-2">
                    <input type="radio" name="gender" value="boy"> Boy<br>
                    <input type="radio" name="gender" value="girl"> Girl<br>
                    <input type="radio" name="gender" value="not specified"> Not Specified<br>
                </div>
                <div class="col-sm-1">
                    <p style="color:white">Nice</p>
                </div>
                <div class="col-sm-2">
                    <input type="radio" name="nice" value="naughty"> Naughty<br>
                    <input type="radio" name="nice" value="nice"> Nice<br>
                </div>
                <div class="col-sm-1">
                    <p style="color:white">Chimney</p>
                </div>
                <div class="col-sm-2">
                    <input type="radio" name="chimney" value="no"> No<br/>
                    <input type="radio" name="chimney" value="yes"> Yes<br/>
                </div>
            </div>
            <div class="row"></div>
            <div class="row form-group">
                <div class="col-sm-2"></div>
                <div class="col-sm-2">
                    <span><button  class="btn btn-light btn-lg btn-block" id="doCreateButton" onclick="doCreate()">Add</button></span>
                    <span><button class="btn btn-light btn-lg btn-block" id="doUpdateButton" onclick="doUpdate()">Update</button class="btn btn-secondary btn-lg"></span>
                </div>
                <div class="col-sm-2">
                    <button  class="btn btn-light btn-lg btn-block" id="doDeleteButton" onclick="doDelete()">Delete</button>
                </div>
                <div class="col-sm-2">
                    <button  class="btn btn-light btn-lg btn-block" id="cancelButton" onclick="doCancel()">Cancel</button>
                </div>
                <div class="col-sm-2"></div>
            </div>

        </div>
        >
        <!-- Create /  Delete / Update Form  -- End -->


</body>
<script>
    function magic(){
        snowStorm.toggleSnow()
    }


        host = window.location.origin
        function showCreate(){

            // Adding the default values
            var person = {}
            person.name = ""
            person.gender = "not specified";
            person.age = 0;
            person.nice = "naughty";
            person.chimney = "no";
            person.toy = "Surprise";
            populateFormWithPerson(person)

            document.getElementById("showCreateButton").style.display="none"
            document.getElementById("theNaughtyList").style.display = "none"
            document.getElementById("naughtyList").style.display = "none"
            document.getElementById("niceList").style.display = "none"
            document.getElementById("theNiceList").style.display="none"
            document.getElementById("createUpdateForm").style.display="block"
            document.getElementById("createLabel").style.display="inline"
            document.getElementById("updateLabel").style.display="none"
            document.getElementById("doCreateButton").style.display="block"
            document.getElementById("doUpdateButton").style.display="none"
            document.getElementById("doDeleteButton").style.display = "none"
        }

        function showUpdate(buttonElement){
            document.getElementById("showCreateButton").style.display="none"
            document.getElementById("theNaughtyList").style.display="none"
            document.getElementById("naughtyList").style.display = "none"
            document.getElementById("niceList").style.display = "none"
            document.getElementById("theNiceList").style.display = "none"
            document.getElementById("createUpdateForm").style.display="block"
            document.getElementById("createLabel").style.display="none"
            document.getElementById("updateLabel").style.display="inline"
            document.getElementById("doCreateButton").style.display="none"
            document.getElementById("doUpdateButton").style.display="block"
            document.getElementById("doDeleteButton").style.display = "block"

            var rowElement = buttonElement.parentNode.parentNode

            // these is a way of finding the closest <tr> which would safer, closest()
            var person = getPersonFromRow(rowElement)
            populateFormWithPerson(person)
        }

        function doCancel(){
            clearForm();
            showViewAll();            
        }

        function doCreate(){
            var form = document.getElementById('createUpdateForm')
            var person = {}
            if ( form.querySelector('input[name="name"]').value ==""){
                alert("Please enter the persons name!")
                return
            }
            // Writes the data to a person object
            person.name = form.querySelector('input[name="name"]').value
            person.gender = getRadioValue("gender")
            person.age = parseInt(form.querySelector('input[name="age"]').value)
            person.nice = getRadioValue("nice")
            person.toy = form.querySelector('input[name="toy"]').value
            person.chimney =  getRadioValue("chimney")

            createPersonAjax(person);
        }

        function setRadioValue(radioName, value) {
            var radios = document.getElementsByName(radioName);
            for (var i = 0, length = radios.length; i < length; i++) {
                if (radios[i].value == value) {
                    // do whatever you want with the checked radio
                    radios[i].checked = true;
                    // only one radio can be logically checked, don't check the rest
                    break;
                }
            }
        }

        function getRadioValue(radioName){
            var radios = document.getElementsByName(radioName);

            for (var i = 0, length = radios.length; i < length; i++) {
                if (radios[i].checked) {
                    // do whatever you want with the checked radio
                    return(radios[i].value);
                    // only one radio can be logically checked, don't check the rest
                    break;
                }
            }
        }

        function clearRadioValue(radioName){
            var radios = document.getElementsByName(radioName);
            for (var i = 0, length = radios.length; i < length; i++)  {
                radios[i].checked = false;
            }
        }

        function createPersonAjax(person){
            $.ajax({
                "url": host+"/list",
                "method": "POST",
                "data": JSON.stringify(person),
                "dataType": "JSON",
                contentType: "application/json; charset=utf-8",
                "success": function (result) {
                    person.id = result.id;
                    addPersonToTable(person);
                    clearForm();
                    showViewAll();
                },
                "error": function (xhr, status, error) {
                    console.log("error: " + status + " msg:" + error);
                }
            });
        }

        function showViewAll(){
            // Re-instates the Naughty and Nice Lists
            document.getElementById("showCreateButton").style.display="block"
            document.getElementById("theNiceList").style.display = "block"
            document.getElementById("naughtyList").style.display = "block"
            document.getElementById("niceList").style.display = "block"
            document.getElementById("theNaughtyList").style.display="block"
            document.getElementById("createUpdateForm").style.display="none"
        }

        function clearForm(){
            // Clears the create person form to make available for next use
            var form = document.getElementById('createUpdateForm')
            form.querySelector('input[name="name"]').value= ""
            clearRadioValue("gender")
            form.querySelector('input[name="age"]').value=""
            clearRadioValue("nice")
            form.querySelector('input[name="toy"]').value=""
            clearRadioValue("chimney")
        }

        function addPersonToTable(person){
            // Adds the person info as a new row to the correct table 
            if (person.nice == "nice") {
                var tableElement = document.getElementById("theNiceList");
            }
            else {
                var tableElement = document.getElementById("theNaughtyList");
            }
            var rowElement = tableElement.insertRow(-1); // -1 refees to adding one at the end
            rowElement.setAttribute('id', person.id);
            // Set attribute here
            var cell1 = rowElement.insertCell(0);
            cell1.innerHTML = person.id;
            var cell2 = rowElement.insertCell(1);
            cell2.innerHTML = person.name;
            var cell3 = rowElement.insertCell(2);
            cell3.innerHTML = person.gender;
            var cell4 = rowElement.insertCell(3);
            cell4.innerHTML = person.age;
            var cell5 = rowElement.insertCell(4);
            cell5.innerHTML = person.nice; 
            var cell6 = rowElement.insertCell(5);
            cell6.innerHTML = person.toy; 
            var cell7 = rowElement.insertCell(6);
            cell7.innerHTML = person.chimney;
            var cell8 = rowElement.insertCell(7);
            cell8.innerHTML = "<button onclick = 'showUpdate(this)'>Action</button>"
        }

        function doDelete(r){
            // Get the persons data
            var person = getPersonFromForm();
            var rowElement = document.getElementById(person.id)
            /*if (person.nice=="nice"){
                var tableElement = document.getElementById('theNiceList')
            }
            else {
                var tableElement = document.getElementById('theNaughtyList')
            }*/
            deletePersonAjax(person.id);
            rowElement.parentNode.removeChild(rowElement)
            //tableElement.deleteRow(r.parentNode.parentNode.rowIndex);
            clearForm();
            showViewAll();
        }

        function deletePersonAjax(id){
                $.ajax({
                    "url": host+ "/list/" + encodeURI(id),
                    // "url": "http://127.0.0.1:5000/list/" + encodeURI(id),
                    "method": "DELETE",
                    "data": "",
                    "dataType": "JSON",
                    contentType: "application/json; charset=utf-8",
                    "success": function (result) {
                        console.log("Deleted" + id);
                    },
                    "error": function (xhr, status, error) {
                        console.log("error: " + status + " msg:" + error);
                    }
                })
        } 
        
        function getPersonFromRow(rowElement){
            // Collects the person's existing data
            var person={}
            person.id = rowElement.getAttribute("id")
            person.name = rowElement.cells[1].firstChild.textContent
            person.gender = rowElement.cells[2].firstChild.textContent
            person.age =  rowElement.cells[3].firstChild.textContent
            person.nice = rowElement.cells[4].firstChild.textContent
            person.toy =  rowElement.cells[5].firstChild.textContent
            person.chimney =  rowElement.cells[6].firstChild.textContent
            return person
        }

        function populateFormWithPerson(person){
            // Populate the form with the info from the row
            var form = document.getElementById("createUpdateForm")
            form.querySelector("input[name='id']").disabled = true
            form.querySelector("input[name='id']").value = person.id
            form.querySelector("input[name='listname']").disabled = true
            form.querySelector("input[name='listname']").value = person.nice
            form.querySelector("input[name='name']").value = person.name
            setRadioValue("gender", person.gender)
            //form.querySelector("input[name='gender'][value=" + person.gender + "]").attr.checked = true ;
            //form.querySelector("input[name='gender']").value = person.gender
            form.querySelector("input[name='age']").value = person.age
            setRadioValue("nice", person.nice)
            //form.querySelector("input[name='nice']").value = person.nice
            form.querySelector("input[name='toy']").value = person.toy
            form.querySelector("input[name='chimney']").value = person.chimney
            setRadioValue("chimney", person.chimney)
        }

        function getPersonFromForm(){
            var form = document.getElementById('createUpdateForm')
            var person = {}
            person.id = form.querySelector('input[name="id"]').value
            person.name = form.querySelector('input[name="name"]').value
            //person.gender = form.querySelector('input[name="gender"]').value
            person.gender = getRadioValue("gender")
            person.age = parseInt(form.querySelector('input[name="age"]').value)
            //person.nice = form.querySelector('input[name="nice"]').value
            person.nice = getRadioValue("nice")
            person.toy = form.querySelector('input[name="toy"]').value
            person.chimney = getRadioValue("chimney")
            //person.chimney = form.querySelector('input[name="chimney"]').value
            return person
        }

        function setPersonInRow(rowElement, person){
            rowElement.cells[0].firstChild.textContent = person.id
            rowElement.cells[1].firstChild.textContent = person.name
            rowElement.cells[2].firstChild.textContent = person.gender
            rowElement.cells[3].firstChild.textContent = person.age
            rowElement.cells[4].firstChild.textContent = person.nice
            rowElement.cells[5].firstChild.textContent = person.toy
            rowElement.cells[6].firstChild.textContent = person.chimney
        }

        function doUpdate(){
            // Get the persons data
            var person = getPersonFromForm();
            // Record the row affected
            var rowElement = document.getElementById(person.id)
            updatePersonAjax(person);
            if (document.getElementById("createUpdateForm").querySelector('input[name="listname"]').value != person.nice){
                doSwapTable(person)
            }
            else{
                setPersonInRow(rowElement, person);
            }
            clearForm();
            showViewAll();
        }

        // When good people turn bad (or vice versa)
        function doSwapTable(person){
            var r = document.getElementById(person.id).rowIndex
            // If the person is now nice
            if (person.nice == "nice") {
                // they must have been in the Naughty Table
                var tableElement = document.getElementById('theNaughtyList')
            }
            else {
                // Or else they were in the Nice Table
                var tableElement = document.getElementById('theNiceList')
            }
            /*
            var index = r.parentNode.parentNode.rowIndex;
            // Delete the row from the old table
            tableElement.deleteRow(r.parentNode.parentNode.rowIndex); */
            tableElement.deleteRow(r);
            // Add person to the correct table
            addPersonToTable(person)
        }


        function updatePersonAjax(person){
            $.ajax({
                "url": host + "/list/" + encodeURI(person.id),
                // "url": "http://127.0.0.1:5000/person/" + encodeURI(person.id), // need encodeURI to automatically addd %20% etc
                "method": "PUT",
                "data": JSON.stringify(person), // converts the person details to JSON string
                "dataType": "JSON",
                contentType: "application/json; charset=utf-8",
                "success": function (result) {
                    console.log(result);
                    // Put the updated person details back in correct row

                },
                "error": function (xhr, status, error) {
                    console.log("error: " + status + " msg:" + error);
                }
            });
        }

        function getAll(){
            $.ajax({
                "url": host + "/list", 
                //"url": "http://127.0.0.1:5000/list",
                "method": "GET",
                "data": "",
                "dataType": "JSON",
                "success": function (result) {
                    for(person of result){
                        addPersonToTable(person);
                    }
                },
                "error": function (xhr, status, error) {
                    console.log("error: " + status + " msg:" + error);
                }
            });

            }

            // Checking whether someone is on the naughty or nice list
            // Only brings back the first answer
            function naughtyOrNice() {
                name = document.getElementById("search").value
                if (name != "") {
                    // Call the function 
                    $.ajax({
                        "url": host + "/list/" + encodeURI(name),
                        "method": "GET",
                        "data": "",
                        "dataType": "JSON",
                        contentType: "application/json; charset=utf-8",
                        "success": function (result) {
                            // Just put it on the alert
                            alert(result.name + " is on the " + result.nice + " list.")
                        },
                        "error": function (xhr, status, error) {
                            console.log("error: " + status + " msg:" + error);
                        }
                    });
                }
            }
            
            function logOut(){
                sessionStorage.setItem("login", "");
                location.href="home.html"
            }

if (sessionStorage.getItem("login") === null || sessionStorage.getItem("login") == "") {
                location.href = "home.html";
            }

    getAll();

    

</script>

</html>